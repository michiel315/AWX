---
- hosts: localhost
  become: no

  tasks:

  - name: 'push metric to dynatrace API'
    uri:
      url: "https://acc.totalapm.idm.atos.net/e/ef713de5-28b4-45ea-9479-d150739df904/api/v2/metrics/ingest"
      status_code: 202
      method: POST
      validate_certs: no
      use_proxy: no
      headers:
        Content-Type: "text/plain"
        Authorization: "Api-token {{ dynatrace_api_token }}"
      body: 'bookings.informationSend,bookingnumber="{{ bookingID }}" 1'
    register: push_metric 


  - name: push metric output
    wait_for:
      timeout: "{{ 30 | random }}"
    
  - name: 'push second metric to dynatrace API'
    uri:
      url: "https://acc.totalapm.idm.atos.net/e/ef713de5-28b4-45ea-9479-d150739df904/api/v2/metrics/ingest"
      status_code: 202
      method: POST
      validate_certs: no
      use_proxy: no
      headers:
        Content-Type: "text/plain"
        Authorization: "Api-token {{ dynatrace_api_token }}"
      body: 'vendor.informationSend="{{ bookingID }}" 1'
      when: push_metric.failed == "false"    
